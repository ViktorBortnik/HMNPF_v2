
Процедура ХМ_НеТиповыеИзменения()
	// ХМНПФ 05.02.2019 ШадринАВ // ДвижениеПоРезервам() // №2012
	// ХМНПФ 05.02.2019 ШадринАВ // ДвижениеПоДопРезервам() // №2012
	// ХМНПФ 19.02.2019 ШадринАВ // ДвижениеПоРезервам() // №2052
	// ХМНПФ 19.02.2019 ШадринАВ // ДвижениеПоДопРезервам() // №2052
	// ХМНПФ 19.02.2019 ШадринАВ // ДвижениеПоИнвестДоходу() // №2052
	// ХМНПФ 10.02.2020 ШадринАВ // ДвижениеПоИнвестДоходу() // №2667
	// ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоРезервам() // №3357
	// ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоДопРезервам() // №3357
	// ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоИнвестДоходу() // №3357
КонецПроцедуры

&ИзменениеИКонтроль("ДвижениеПоДопРезервам")
Процедура РасшОбщ_ДвижениеПоДопРезервам(ВидДвиженияСтрока, ДатаДвижения, СтрокаТаблицы, ТекСумма)
	Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.Выплатной Тогда
		Движение = Движения.уп_РезервыОПСНераспределенныеПлатежи.Добавить();
		Если ВидДвиженияСтрока = "Приход" Тогда
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Иначе
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		КонецЕсли;
		Движение.Период      = ДатаДвижения;
		Движение.Организация = Организация;
		Движение.ВидОперации = Перечисления.уп_ВидыОперацийПослеУчетнойДаты.ИнвестДоход;
		Движение.ДатаСобытия = КонецПериода;
		Движение.ДатаОтраженияСобытия = Дата;
		//Если СтрокаТаблицы.СостояниеДоговораОПС = Перечисления.уп_СостоянияДоговоровОПС.Закрыт
		//	и СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
		//	Движение.ДоговорОПС  = Справочники.уп_ДоговорыОПС.ПустаяСсылка();
		//Иначе
		#Удаление
		Если ПоДоговорам Тогда
     		Движение.ДоговорОПС  = СтрокаТаблицы.ДоговорОПС;
		КонецЕсли;	
		#КонецУдаления
		//КонецЕсли;
		#Вставка
		// +ХМНПФ 19.02.2019 ШадринАВ // ДвижениеПоДопРезервам() // №2052		
		Движение.ДоговорОПС  = СтрокаТаблицы.ДоговорОПС;
		// -ХМНПФ 19.02.2019 ШадринАВ // ДвижениеПоДопРезервам() // №2052
		#КонецВставки
		Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.Выплатной;
		Если ПоТипамСумм Тогда
			Движение.ТипСуммы  = СтрокаТаблицы.ТипСуммыРез;
		КонецЕсли;
		Движение.Сумма       = ТекСумма;
		Движение.ДокументРегистрации = ДокументРегистрации;
		Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПСРПВ;
	ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервОПС Тогда
		Движение = Движения.уп_РезервыОПСНераспределенныеПлатежи.Добавить();
		Если ВидДвиженияСтрока = "Приход" Тогда
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Иначе
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		КонецЕсли;
		Движение.Период      = ДатаДвижения;
		Движение.Организация = Организация;
		Движение.ВидОперации = Перечисления.уп_ВидыОперацийПослеУчетнойДаты.ИнвестДоход;
		Движение.ДатаСобытия = КонецПериода;
		Движение.ДатаОтраженияСобытия = Дата;
		Движение.ДоговорОПС  = Справочники.уп_ДоговорыОПС.ПустаяСсылка();
		Движение.ТипРезерва = ТипРезерва;
		Движение.Сумма       = СтрокаТаблицы.ТипСуммы;
		Движение.ДокументРегистрации = ДокументРегистрации;
		Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПС;
	Иначе	
		Движение = Движения.уп_РезервыОПСНераспределенныеПлатежи.Добавить();
		Если ВидДвиженияСтрока = "Приход" Тогда
			Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Иначе
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
		КонецЕсли;
		Движение.Период      = ДатаДвижения;
		Движение.Организация = Организация;
		Движение.ВидОперации = Перечисления.уп_ВидыОперацийПослеУчетнойДаты.ИнвестДоход;
		Движение.ДатаСобытия = КонецПериода;
		Движение.ДатаОтраженияСобытия = Дата;
		Движение.ДоговорОПС  = СтрокаТаблицы.ДоговорОПС;
		Движение.ТипРезерва  = ТипРезерва;
		Если ВедетсяРезервНаследников И ЗначениеЗаполнено(СтрокаТаблицы.ДоговорОПС.ДатаРегистрацииСмерти) 
			И Дата > СтрокаТаблицы.ДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
			Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервПенсионныйНакоплений Тогда
				Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервНаследниковРПН;
			ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервСрочнойВыплаты Тогда
				Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервНаследниковРСВ;
			КонецЕсли;	
		КонецЕсли;
		
		//резерв ЕВ
		Если ВедетсяРезервЕВ И ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервПенсионныйНакоплений Тогда 
			ПереводитьвРезервЕВ = Ложь;
			#Вставка
			// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоДопРезервам() // №3357
			Если НЕ (ЗначениеЗаполнено(СтрокаТаблицы.ДоговорОПС.ДатаРегистрацииСмерти)
				И Дата > СтрокаТаблицы.ДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти) Тогда
			// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоДопРезервам() // №3357
			#КонецВставки
			Если  (ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ) И НЕ ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)) //не было решения о доплате
				ИЛИ (ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ) И ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)
				#Удаление
				И ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ)> ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)) Тогда   //было решение о доплате но по прошлому заявлению
				#КонецУдаления
				#Вставка
				// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоДопРезервам() // №3357
				И СтрокаТаблицы.ДатаРешенияОЕВ > СтрокаТаблицы.ДатаРешенияОДоплате) Тогда
				// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоДопРезервам() // №3357
				#КонецВставки
				Если СтрокаТаблицы.ВключатьДопВзносы Тогда
					ПереводитьвРезервЕВ = Истина;
				Иначе
					Если СтрокаТаблицы.ТипСуммы = Справочники.уп_ТипыСуммОПС.ВзносыФиз
						ИЛИ СтрокаТаблицы.ТипСуммы = Справочники.уп_ТипыСуммОПС.ИДФиз Тогда
						ПереводитьвРезервЕВ = Истина;
					КонецЕсли;	
				КонецЕсли;	
			КонецЕсли;
			Если ПереводитьВРезервЕВ Тогда
				Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервЕВ;
			КонецЕсли;
			#Вставка
			// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоДопРезервам() // №3357
			КонецЕсли;
			// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоДопРезервам() // №3357
			#КонецВставки
		КонецЕсли;
		Движение.ТипСуммы    = СтрокаТаблицы.ТипСуммыРез;
		Движение.Сумма       = ТекСумма;
		Движение.ДокументРегистрации = ДокументРегистрации;
		Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервСрочнойВыплаты Тогда
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПСРСВ;
		Иначе
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПС;
		КонецЕсли;	
	КонецЕсли;
КонецПроцедуры

&ИзменениеИКонтроль("ДвижениеПоИнвестДоходу")
Процедура РасшОбщ_ДвижениеПоИнвестДоходу(ТекДоговорОПС, ТекТипСуммы, ТекСумма, ТекРублеДни, ТекПроцент, СтрокаТаблицы)
	Движение = Движения.уп_ИнвестДоходОПС.Добавить();
	Движение.Период = Дата;
	Движение.Организация = Организация;
	Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервОПС Тогда
		Движение.ДоговорОПС = Справочники.уп_ДоговорыОПС.ПустаяСсылка();
		Движение.ТипСуммы = Справочники.уп_ТипыСуммОПС.ПустаяСсылка();
	//ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.Выплатной И ТекСостояние = Перечисления.уп_СостоянияДоговоровОПС.Закрыт Тогда
	//	Движение.ДоговорОПС = Справочники.уп_ДоговорыОПС.ПустаяСсылка();
	//	Движение.ТипСуммы = Справочники.уп_ТипыСуммОПС.ПустаяСсылка();
	ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.Выплатной Тогда
		Если ПоДоговорам Тогда
			Движение.ДоговорОПС  = ТекДоговорОПС;
		КонецЕсли;
		Если ПоТипамСумм Тогда
			Движение.ТипСуммы  = ТекТипСуммы;
		КонецЕсли;
	Иначе
		Движение.ДоговорОПС = ТекДоговорОПС;
		Движение.ТипСуммы = ТекТипСуммы;
	КонецЕсли;
	Движение.ТипРезерва = ТипРезерва;
	Если ВедетсяРезервНаследников И ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти) 
		И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
		Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервПенсионныйНакоплений Тогда
			Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервНаследниковРПН;
		ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервСрочнойВыплаты Тогда
			Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервНаследниковРСВ;
		КонецЕсли;	
	КонецЕсли;
		
	//резерв ЕВ
	Если ВедетсяРезервЕВ И ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервПенсионныйНакоплений Тогда 
		ПереводитьвРезервЕВ = Ложь;
		#Вставка
		// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоИнвестДоходу() // №3357
		Если НЕ (ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти)
			И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти) Тогда
		// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоИнвестДоходу() // №3357
		#КонецВставки
		Если  (ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ) И НЕ ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)) //не было решения о доплате
			ИЛИ (ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ) И ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)
			#Удаление
			И ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ)> ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)) Тогда   //было решение о доплате но по прошлому заявлению
			#КонецУдаления
			#Вставка
			// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоИнвестДоходу() // №3357
			И СтрокаТаблицы.ДатаРешенияОЕВ > СтрокаТаблицы.ДатаРешенияОДоплате) Тогда
			// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоИнвестДоходу() // №3357
			#КонецВставки
			Если СтрокаТаблицы.ВключатьДопВзносы Тогда
				ПереводитьвРезервЕВ = Истина;
			Иначе
				Если СтрокаТаблицы.ТипСуммы = Справочники.уп_ТипыСуммОПС.ВзносыФиз
					ИЛИ СтрокаТаблицы.ТипСуммы = Справочники.уп_ТипыСуммОПС.ИДФиз Тогда
					ПереводитьвРезервЕВ = Истина;
				КонецЕсли;	
			КонецЕсли;	
		КонецЕсли;
		Если ПереводитьВРезервЕВ Тогда
			Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервЕВ;
		КонецЕсли;
		#Вставка
		// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоИнвестДоходу() // №3357
		КонецЕсли;
		// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоИнвестДоходу() // №3357
		#КонецВставки
	КонецЕсли;
	Движение.Сумма = ТекСумма;
	Движение.РублеДни = ТекРублеДни;
	Движение.Процент = ТекПроцент;
	Движение.ДнейВПериоде = Цел((КонецДня(КонецПериода)-НачалоДня(НачалоПериода)+1)/(60*60*24));
	Движение.НачПериода = НачалоДня(НачалоПериода);
	Движение.КонПериода = КонецДня(КонецПериода);
	Если ТекСумма<0 Тогда
		Движение.ОтрицательныеСуммыДляТрансляции = -ТекСумма;
	КонецЕсли;
	Движение.ИсточникИД = ИсточникИД;
КонецПроцедуры	

&ИзменениеИКонтроль("ДвижениеПоРезервам")
Процедура РасшОбщ_ДвижениеПоРезервам(ТекДоговорОПС, ТекТипСуммы, ТекСумма, СтрокаТаблицы)
	Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.Выплатной Тогда
		Движение = Движения.уп_РезервыОПС.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период      = Дата;
		Движение.Организация = Организация;
		//Если СтрокаТаблицы.СостояниеДоговораОПС = Перечисления.уп_СостоянияДоговоровОПС.Закрыт
		//	и СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
		//	Движение.ДоговорОПС  = Справочники.уп_ДоговорыОПС.ПустаяСсылка();
		//Иначе
		#Удаление
		Если ПоДоговорам Тогда

			Движение.ДоговорОПС  = ТекДоговорОПС;
		КонецЕсли;	
		//КонецЕсли;

		#КонецУдаления
		#Вставка
		// +ХМНПФ 19.02.2019 ШадринАВ // ДвижениеПоРезервам() // №2052
			Движение.ДоговорОПС  = ТекДоговорОПС;
		#КонецВставки

		Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.Выплатной;
		Если ПоТипамСумм Тогда
			Движение.ТипСуммы  = ТекТипСуммы;
		КонецЕсли;
		Движение.Сумма       = ТекСумма;
		Движение.ДокументРегистрации = ДокументРегистрации;
		Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПСРПВ;
		Если ИсточникИД = Перечисления.уп_ВидыИсточниковНачисленияИДОПС.ЗаСчетРОПС Тогда
			Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Перевод_Из_РОПС_в_РВ;	
		ИначеЕсли ИсточникИД = Перечисления.уп_ВидыИсточниковНачисленияИДОПС.ЗаСчетСС Тогда
			Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Пополнение_РВ_Собственные_Средства;	
		Иначе
			
		КонецЕсли; 
		
	ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервОПС Тогда
		Движение = Движения.уп_РезервыОПС.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период      = Дата;
		Движение.Организация = Организация;
		Движение.ДоговорОПС  = Справочники.уп_ДоговорыОПС.ПустаяСсылка();
		Движение.ТипРезерва = ТипРезерва;
		Движение.Сумма       = ТекСумма;
		Движение.ДокументРегистрации = ДокументРегистрации;
		Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПС;
	Иначе	
		Движение = Движения.уп_РезервыОПС.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период      = Дата;
		Движение.Организация = Организация;
		Движение.ДоговорОПС  = ТекДоговорОПС;
		Движение.ТипРезерва  = ТипРезерва;
		Если ВедетсяРезервНаследников И ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти) 
			И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
			Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервПенсионныйНакоплений Тогда
				Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервНаследниковРПН;
			ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервСрочнойВыплаты Тогда
				Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервНаследниковРСВ;
			КонецЕсли;	
		КонецЕсли;
		
		//резерв ЕВ
		Если ВедетсяРезервЕВ И ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервПенсионныйНакоплений Тогда 
			ПереводитьвРезервЕВ = Ложь;
			#Вставка
			// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоРезервам() // №3357
			Если НЕ (ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти)
				И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти) Тогда
			// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоРезервам() // №3357
			#КонецВставки
			Если  (ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ) И НЕ ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)) //не было решения о доплате
				ИЛИ (ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОЕВ) И ЗначениеЗаполнено(СтрокаТаблицы.ДатаРешенияОДоплате)
				И СтрокаТаблицы.ДатаРешенияОЕВ>СтрокаТаблицы.ДатаРешенияОДоплате) Тогда   //было решение о доплате но по прошлому заявлению
				Если СтрокаТаблицы.ВключатьДопВзносы Тогда
					ПереводитьвРезервЕВ = Истина;
				Иначе
					Если ТекТипСуммы = Справочники.уп_ТипыСуммОПС.ВзносыФиз
						ИЛИ ТекТипСуммы = Справочники.уп_ТипыСуммОПС.ИДФиз Тогда
						ПереводитьвРезервЕВ = Истина;
					КонецЕсли;	
				КонецЕсли;	
			КонецЕсли;
			Если ПереводитьВРезервЕВ Тогда
				Движение.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервЕВ;
			КонецЕсли;	
			#Вставка
			// +ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоРезервам() // №3357
			КонецЕсли;
			// -ХМНПФ 15.10.2021 ШадринАВ // ДвижениеПоРезервам() // №3357
			#КонецВставки
   		КонецЕсли;
		Движение.ТипСуммы    = ТекТипСуммы;
		Движение.Сумма       = ТекСумма;
		Движение.ДокументРегистрации = ДокументРегистрации;
		Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервСрочнойВыплаты Тогда
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПСРСВ;
			Если ИсточникИД = Перечисления.уп_ВидыИсточниковНачисленияИДОПС.ЗаСчетРОПС Тогда
				Если ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти) 
					И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Перевод_Из_РОПС_в_РСВУмерших;
				Иначе
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Перевод_Из_РОПС_в_РСВ;
				КонецЕсли;
			ИначеЕсли ИсточникИД = Перечисления.уп_ВидыИсточниковНачисленияИДОПС.ЗаСчетСС Тогда
				Если ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти) 
					И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Пополнение_РСВУмерших_Собственные_Средства;	
				Иначе
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Пополнение_РСВ_Собственные_Средства;	
				КонецЕсли;
			Иначе
			КонецЕсли; 
		Иначе
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПС;
			Если ИсточникИД = Перечисления.уп_ВидыИсточниковНачисленияИДОПС.ЗаСчетРОПС Тогда
				Если ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти) 
					И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Перевод_Из_РОПС_в_РПНУмерших;
				Иначе
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Перевод_Из_РОПС_в_РПН;	
				Конецесли	
			ИначеЕсли ИсточникИД = Перечисления.уп_ВидыИсточниковНачисленияИДОПС.ЗаСчетСС Тогда
				Если ЗначениеЗаполнено(ТекДоговорОПС.ДатаРегистрацииСмерти) 
					И Дата > ТекДоговорОПС.ДатаРегистрацииСмерти И СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.ПоСмерти Тогда
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Пополнение_РПНУмерших_Собственные_Средства;	
				Иначе
					Движение.ВидДвиженияЕПС = Перечисления.епс_ВидыДвиженияПенсионныхНакоплений.Пополнение_РПН_Собственные_Средства;	
				КонецЕсли;	
			Иначе
			КонецЕсли; 
		КонецЕсли;	
		Если СтрокаТаблицы.СостояниеДоговораОПС = Перечисления.уп_СостоянияДоговоровОПС.Закрыт 
			и (СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.Досрочное ИЛИ СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.НеВступилВСилу) И (НЕ НеСписыватьИДСразу) Тогда
			
			Движение = Движения.уп_РезервыОПС.Добавить();
			Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
			Движение.Период      = Дата;
			Движение.Организация = Организация;
			Движение.ДоговорОПС  = ТекДоговорОПС;
			Движение.ТипРезерва  = ТипРезерва;
			Движение.ТипСуммы    = ТекТипСуммы;
			Движение.Сумма       = ТекСумма;
			Движение.ДокументРегистрации = ДокументРегистрации;
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ПереводВДругойПФ;
			
			Движение                     = Движения.уп_ПрочиеНачисленияОПС.Добавить();
			Движение.ВидДвижения         = ВидДвиженияНакопления.Приход;
			Движение.Период              = Дата;
			Движение.Организация         = Организация;
			Движение.ДоговорОПС          = ТекДоговорОПС;
			Движение.ДокументРегистрации = ДокументРегистрации;
			Движение.ТипСуммы            = ТекТипСуммы;
			Движение.ТипВыплаты          = Перечисления.уп_ТипыВыплат.ПереводВДругойПФ;
			
			//надо выяснить куда он ушел
			Если СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.Досрочное Тогда
				Движение.Участник = СтрокаТаблицы.СледующийСтраховщик;
				Сообщить("По договору № "+СокрЛП(ТекДоговорОПС.Код)+" средства начислены к выплате страховщику "+СокрЛП(СтрокаТаблицы.СледующийСтраховщик.Наименование));
			ИначеЕсли СтрокаТаблицы.ПричинаЗакрытия = Перечисления.уп_ПричиныЗакрытияДоговораОПС.НеВступилВСилу Тогда
				Движение.Участник = СтрокаТаблицы.ПредыдущийСтраховщик;
				Сообщить("По договору № "+СокрЛП(ТекДоговорОПС.Код)+" средства начислены к выплате страховщику "+СокрЛП(СтрокаТаблицы.ПредыдущийСтраховщик.Наименование));
			КонецЕсли;	
			Движение.Сумма = ТекСумма;
				
			Если ОтражатьВБухгалтерскомУчете  и ПроводкиПоНачислению Тогда
				уп_ОбщегоНазначенияУчетРезервов.ДобавитьСтрокуВТабБухУчет(ТабБухУчет, Дата, Организация, Перечисления.уп_ВидыДвижений.ПереводВДругойПФ, ТекДоговорОПС.Участник, ТекДоговорОПС.ДоговорКонтрагента,
				Справочники.уп_ПенсионныеСхемы.ПустаяСсылка(), Ложь, СтрокаТаблицы.СледующийСтраховщик, СтрокаТаблицы.СледующийСтраховщик.ОсновнойДоговорКонтрагента, Справочники.уп_ПенсионныеСхемы.ПустаяСсылка(), Ложь, ТекСумма);
			КонецЕсли;
		КонецЕсли;	
	КонецЕсли;
КонецПроцедуры

Процедура ХМ_ЗАГРУЗКА_ОбработкаПроведения(Отказ, РежимПроведения, СтрокаТЗ, СтруктураТЧ) Экспорт
	Если НЕ ПРОВЕДЕН Тогда
		#Если Сервер Тогда
			ХМ_ЗагрузкаТЗ_Сервер.ЗаписатьОбъект(Движения.уп_ИнвестДоходОПС);
			ХМ_ЗагрузкаТЗ_Сервер.ЗаписатьОбъект(Движения.уп_РезервыОПС);
		#КонецЕсли
		Возврат;	
	КонецЕсли;
	
	Структура_ТЗ = СтруктураТЧ.ТЗНачислений;	
	СтрокиНаДобавление = Структура_ТЗ.ТЗ.НайтиСтроки(Новый Структура(Структура_ТЗ.Узел.Каспер_поле,СтрокаТЗ[Структура_ТЗ.Узел.Каспер_поле]));
	Для каждого стр из СтрокиНаДобавление Цикл
		Движение = Движения.уп_РезервыОПС.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период      = стр.ХМ_ДатаВыплаты;
		Движение.Организация = Организация;
		Движение.ДоговорОПС  = стр.ДоговорОПС;
		Движение.ТипРезерва = стр.ТипРезерва;
		Движение.ТипСуммы  = стр.ТипСуммы;
		Движение.Сумма     = стр.Сумма;
		Движение.ДокументРегистрации = ДокументРегистрации;
		Если стр.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.Выплатной Тогда
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПСРПВ;
		ИначеЕсли стр.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервСрочнойВыплаты Тогда
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПСРСВ;
		ИначеЕсли стр.ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервПенсионныйНакоплений Тогда
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДОПС;
		ИначеЕсли ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервОПС Тогда
			Движение.Движение    = Перечисления.уп_ВидыДвижений.ИДРезервОПС;
			ВызватьИсключение "Необходимо учесть дополнительную аналитику по резурву ОПС!";
			//--Движение.ДоговорОПС  = стр.ТекДоговорОПС;
			//--Движение.ТипРезерва = ТипРезерва;
			//--Движение.ТипСуммы  = стр.ТипСуммы;
		КонецЕсли;

		Движение = Движения.уп_ИнвестДоходОПС.Добавить();
		Движение.Период = стр.ХМ_ДатаВыплаты;
		Движение.Организация = Организация;
		Если ТипРезерва = Перечисления.уп_ТипыРезервовОПС.РезервОПС Тогда
//--			Движение.ДоговорОПС = Справочники.уп_ДоговорыОПС.ПустаяСсылка();
//--			Движение.ТипСуммы = Справочники.уп_ТипыСуммОПС.ПустаяСсылка();
		Иначе
			Движение.ДоговорОПС  = стр.ДоговорОПС;
			Движение.ТипСуммы  = стр.ТипСуммы;
		КонецЕсли;
		Движение.ТипРезерва = стр.ТипРезерва;
		Движение.Сумма     = стр.Сумма;
	КонецЦикла;	
	
	#Если Сервер Тогда
		ХМ_ЗагрузкаТЗ_Сервер.ЗаписатьОбъект(Движения.уп_ИнвестДоходОПС);
		ХМ_ЗагрузкаТЗ_Сервер.ЗаписатьОбъект(Движения.уп_РезервыОПС);
	#КонецЕсли
	
КонецПроцедуры

&После("ОбработкаПроведения")
Процедура ХМОбработкаПроведения(Отказ, Режим)
	Идентификатор =  "Форма27%";
	ФормаОтчета = "ИНСПН-В (Форма 27)";
	НазваниеОтчета = "Информация о результате инвестирования средств пенсионных накоплений," + 
	" отраженном на пенсионном счете накопительной пенсии застрахованного лица," + 
	" получающего ежемесячные выплаты за счет средств пенсионных накоплений, по итогам финансового года";
	Дата = ДатаРасчета;
	ХМ_ПодпискиНаСобытия_Сервер.ДобавитьОповещениеВРегистр(ЭтотОбъект, Дата, Идентификатор, НазваниеОтчета, ФормаОтчета);
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	Идентификатор =  "Форма28%";
	ФормаОтчета = "ИНСПН (Форма 28)";
	НазваниеОтчета = "Информация о результате инвестирования средств пенсионных накоплений," + 
	" отраженном на пенсионном счете накопительной пенсии застрахованного  лица," + 
	" не получающего ежемесячные выплаты за счет средств пенсионных накоплений, по итогам финансового года";
	ХМ_ПодпискиНаСобытия_Сервер.ДобавитьОповещениеВРегистр(ЭтотОбъект, Дата, Идентификатор, НазваниеОтчета, ФормаОтчета);
КонецПроцедуры
