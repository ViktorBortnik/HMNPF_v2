//https://redmine.npf.com/issues/4713

&НаКлиенте
Перем ФормаДлительнойОперации Экспорт;
// Конец ИнтернетПоддержкаПользователей.РаботаСКонтрагентами

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКоманды.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	Если Параметры.Ключ.Пустая() Тогда
		ПодготовитьФормуНаСервере();
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.Ответственный) Тогда
		Объект.Ответственный = Пользователи.ТекущийПользователь();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКомандыКлиент.НачатьОбновлениеКоманд(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	// СтандартныеПодсистемы.ДатыЗапретаИзменения
	ДатыЗапретаИзменения.ОбъектПриЧтенииНаСервере(ЭтаФорма, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.ДатыЗапретаИзменения
	
	ПодготовитьФормуНаСервере();
	
	// СтандартныеПодсистемы.ПодключаемыеКоманды
	ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
	// Конец СтандартныеПодсистемы.ПодключаемыеКоманды
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если ПараметрыЗаписи.РежимЗаписи = ПредопределенноеЗначение("РежимЗаписиДокумента.Проведение") Тогда
		КлючеваяОперация = "Проведение_хм_АктСверкиИПСиСПС";
		ОценкаПроизводительностиКлиент.НачатьЗамерВремени(Истина, КлючеваяОперация);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	УстановитьСостояниеДокумента();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	Оповестить("Запись_хм_АктСверкиИПСиСПС", ПараметрыЗаписи, Объект.Ссылка);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	
	Если НачалоДня(Объект.Дата) = НачалоДня(ТекущаяДатаДокумента) Тогда
		// Изменение времени не влияет на поведение документа.
		ТекущаяДатаДокумента = Объект.Дата;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.Организация) Тогда
		ОрганизацияПриИзмененииНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьИндекс(Участок)
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	епс_ДополнительныеСведенияСрезПоследних.Значение КАК Значение,
		|	епс_ДополнительныеСведенияСрезПоследних.Объект КАК Объект
		|ИЗ
		|	РегистрСведений.епс_ДополнительныеСведения.СрезПоследних(
		|			&КонПериода,
		|			Свойство = &Индекс
		|				И Объект = &Объект) КАК епс_ДополнительныеСведенияСрезПоследних";
	
	Запрос.УстановитьПараметр("Индекс", ПланыВидовХарактеристик.епс_ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя","index_sup_num"));
	Запрос.УстановитьПараметр("КонПериода", Объект.Дата);
	Запрос.УстановитьПараметр("Объект", Участок.Владелец);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если  ВыборкаДетальныеЗаписи.Следующий() Тогда
		Возврат(ВыборкаДетальныеЗаписи.Значение);
	КонецЕсли;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
КонецФункции

&НаКлиенте
Процедура спУчастникиУчастокПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.спУчастники.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		Если ЗначениеЗаполнено (ТекущиеДанные.Участок)  Тогда 
			
			РеквизитыУчастка = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ТекущиеДанные.Участок,"Территория,ДоставочныйДень");
			ТерриторияУчастка =  РеквизитыУчастка.Территория;
			Если Объект.Территория <>  ТерриторияУчастка И ЗначениеЗаполнено(Объект.Территория) Тогда
				Сообщение = Новый СообщениеПользователю;
				Сообщение.Текст = "Территория документа "+СокрЛП(Объект.Территория)+ ", территория участка " + ТерриторияУчастка + "."; 
				Сообщение.Сообщить();
			КонецЕсли; 
			
			ТекущиеДанные.Территория = ТерриторияУчастка;	
			ТекущиеДанные.ДоставочныйДень = РеквизитыУчастка.ДоставочныйДень;
			ТекущиеДанные.Индекс = ПолучитьИндекс(ТекущиеДанные.Участок);	

		КонецЕсли;
	КонецЕсли;

КонецПроцедуры
 
&НаКлиенте
Процедура КаталогЭкспортаНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ВыборКаталога = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.ВыборКаталога);
	ВыборКаталога.Каталог = Объект.КаталогЭкспорта;
	ВыборКаталога.Показать(Новый ОписаниеОповещения("КаталогЭкспортаЗавершениеВыбора", ЭтотОбъект));
	
КонецПроцедуры

&НаКлиенте
Процедура КаталогЭкспортаЗавершениеВыбора(ВыбранныеФайлы, ДополнительныеПараметры) Экспорт
	
	Если ВыбранныеФайлы = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ВыбранныеФайлы.Количество() > 0 Тогда
		Объект.КаталогЭкспорта = ВыбранныеФайлы[0];
	КонецЕсли;
	
КонецПроцедуры                           

&НаКлиенте
Процедура ЗаписатьДанныеДоставкиУчастников(Команда)
	ЗаписатьДанныеДоставкиУчастниковНаСервере();  
    ЭтотОбъект.Прочитать()
КонецПроцедуры

&НаКлиенте
Процедура ВыплатныеРеестрыВыбратьПериод(Команда)
	
	ПараметрыФормы = Новый Структура("НачалоПериода, КонецПериода", Объект.ВыплатныеРеестрыНачалоПериода, Объект.ВыплатныеРеестрыКонецПериода);
	ОписаниеОповещения = Новый ОписаниеОповещения("ВыбратьПериодЗавершение", ЭтотОбъект);
	ОткрытьФорму("ОбщаяФорма.ВыборСтандартногоПериода", ПараметрыФормы, Элементы.ВыплатныеРеестрыВыбратьПериод, , , , ОписаниеОповещения);
	
КонецПроцедуры      
 


////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаСервере
Процедура ПодготовитьФормуНаСервере()
	
	УстановитьСостояниеДокумента();
	
	ТекущаяДатаДокумента = Объект.Дата;
	
	ВалютаРегламентированногоУчета = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета();
	
	УправлениеФормой(ЭтаФорма);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьСостояниеДокумента()
	
	СостояниеДокумента = ОбщегоНазначенияБП.СостояниеДокумента(Объект);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УправлениеФормой(Форма)
	
	Элементы = Форма.Элементы;
	Объект   = Форма.Объект;
	
   	Элементы.ГруппаУчастники.Видимость = Не ЗначениеЗаполнено(Объект.ВидДеятельности) ИЛИ Объект.ВидДеятельности = ПредопределенноеЗначение("Перечисление.уп_ВидыДеятельности.ПР")

КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ
//

// Серверная обработка изменения реквизитов:

&НаСервере
Процедура ДатаПриИзмененииНаСервере()
	
	УправлениеФормой(ЭтаФорма);
	
КонецПроцедуры


&НаСервере
Процедура ОрганизацияПриИзмененииНаСервере()
	
	УправлениеФормой(ЭтаФорма);
	
КонецПроцедуры

// Внешний вид, содержание надписей и т.п.

&НаСервере
Процедура УстановитьУсловноеОформление()
	
	НастройкиУсловногоОформления = Новый Структура();
	
	УсловноеОформление.Элементы.Очистить();
	
	// Условное оформление для полей, расположенных на страницах
	
	ОбновитьУсловноеОформление(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ОбновитьУсловноеОформление(Форма)
	
	Элементы = Форма.Элементы;
	
	Если НЕ Форма.НастройкиУсловногоОформления.Свойство("ГлавноеПроинициализировано")
		И Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаГлавное Тогда
		
		Форма.УстановитьУсловноеОформлениеГлавное();
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформлениеГлавное() Экспорт
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ БСП


// СтандартныеПодсистемы.ПодключаемыеКоманды
&НаКлиенте
Процедура Подключаемый_ВыполнитьКоманду(Команда)
	ПодключаемыеКомандыКлиент.ВыполнитьКоманду(ЭтотОбъект, Команда, Объект);
КонецПроцедуры

&НаСервере
Процедура Подключаемый_ВыполнитьКомандуНаСервере(Контекст, Результат)
	ПодключаемыеКоманды.ВыполнитьКоманду(ЭтотОбъект, Контекст, Объект, Результат);
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ОбновитьКоманды()
	ПодключаемыеКомандыКлиентСервер.ОбновитьКоманды(ЭтотОбъект, Объект);
КонецПроцедуры


&НаКлиенте
Процедура ВыбратьПериодЗавершение(РезультатВыбора, ДопПараметры) Экспорт
	
	Если РезультатВыбора = Неопределено Тогда
		Возврат;
	КонецЕсли;
	Объект.ВыплатныеРеестрыНачалоПериода    = РезультатВыбора.НачалоПериода;
	Объект.ВыплатныеРеестрыКонецПериода 	= РезультатВыбора.КонецПериода;
	
	ПриИзмененииПериода();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииПериода()
	
	Если (ТекущийПериод.ДатаНачала <> Объект.ВыплатныеРеестрыНачалоПериода
		ИЛИ ТекущийПериод.ДатаОкончания <> КонецДня(Объект.ВыплатныеРеестрыКонецПериода))
		И Объект.тчВыплатныеРеестры.Количество() > 0 Тогда
		
		ОписаниеОповещения = Новый ОписаниеОповещения("ВопросПриИзмененииПериодаЗавершение", ЭтотОбъект);
		Текст = НСтр("ru='При изменении периода табличная часть будет очищена. Изменить период?'");
		ПоказатьВопрос(ОписаниеОповещения, Текст, РежимДиалогаВопрос.ДаНет, 0, КодВозвратаДиалога.Да);
	КонецЕсли;
	
КонецПроцедуры    

&НаКлиенте
Процедура ВопросПриИзмененииПериодаЗавершение(Ответ, ДополнительныеПараметры) Экспорт
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ТекущийПериод.ДатаНачала    			= Объект.ВыплатныеРеестрыНачалоПериода;
		ТекущийПериод.ДатаОкончания 			= Объект.ВыплатныеРеестрыКонецПериода;
		ОчиститьДанныетчВыплатныеРеестры(ЭтотОбъект);
	Иначе
		Объект.ВыплатныеРеестрыНачалоПериода    = ТекущийПериод.ДатаНачала;
		Объект.ВыплатныеРеестрыКонецПериода 	= ТекущийПериод.ДатаОкончания;
	КонецЕсли;
	
КонецПроцедуры        

&НаКлиентеНаСервереБезКонтекста
Процедура ОчиститьДанныетчВыплатныеРеестры(Форма)
	
	Объект = Форма.Объект;
	
	Объект.тчВыплатныеРеестры.Очистить();
	
КонецПроцедуры

&НаСервере
Процедура ЗапомнитьТекущиеЗначенияПериода()
	
	ТекущийПериод.ДатаНачала        = Объект.ВыплатныеРеестрыНачалоПериода;
	ТекущийПериод.ДатаОкончания     = Объект.ВыплатныеРеестрыКонецПериода;
	
КонецПроцедуры




&НаСервере
Процедура ЗаписатьДанныеДоставкиУчастниковНаСервере()
		//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	докОбъект  = РеквизитФормыВЗначение("Объект");
	Если докОбъект.Модифицированность() Тогда
		докОбъект.Записать();
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	хм_ВыгрузкаОписиИПорученииПенсияНаПочтуспУчастники.Участник КАК Участник,
		|	хм_ВыгрузкаОписиИПорученииПенсияНаПочтуспУчастники.Участок КАК Участок,
		|	хм_ВыгрузкаОписиИПорученииПенсияНаПочтуспУчастники.ДоставочныйДень КАК ДоставочныйДень,
		|	хм_ВыгрузкаОписиИПорученииПенсияНаПочтуспУчастники.Индекс КАК Индекс
		|ИЗ
		|	Документ.хм_ВыгрузкаОписиИПорученииПенсияНаПочту.спУчастники КАК хм_ВыгрузкаОписиИПорученииПенсияНаПочтуспУчастники
		|ГДЕ
		|	хм_ВыгрузкаОписиИПорученииПенсияНаПочтуспУчастники.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка",Объект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	       
	
	Пока Выборка.Следующий() Цикл 
		
		Если ЗначениеЗаполнено(Выборка.Участок)	Тогда
			Если Объект.Территория = Выборка.Участок.Территория Тогда
				
				НаборЗаписей = РегистрыСведений.хм_ДоставочныеУчасткиУчастников.СоздатьМенеджерЗаписи();
				НаборЗаписей.Организация = Объект.Организация;
				НаборЗаписей.Участник =  Выборка.Участник;  
				НаборЗаписей.Участок  =  Выборка.Участок;
				НаборЗаписей.Записать();  
			Иначе
				Сообщение = Новый СообщениеПользователю;
				Сообщение.Текст = "Территория документа "+СокрЛП(Объект.Территория)+ ", территория участка " + Выборка.Участок.Территория + ", данные не записанны..."; 
				Сообщение.Сообщить();
			КонецЕсли;
		КонецЕсли;
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
	КонецЦикла;
	
КонецПроцедуры





//////////////////////////////////////////////////////////
#Область ОсновнойКод
&НаКлиенте
Процедура ВыплатныеРеестрыЗаполнитьПоПериоду(Команда)	
	ВыплатныеРеестрыЗаполнитьПоПериодуНаСервере();	
КонецПроцедуры

&НаСервере
Процедура ВыплатныеРеестрыЗаполнитьПоПериодуНаСервере()
    ТЗ = Документы.хм_ВыгрузкаОписиИПорученииПенсияНаПочту.ПолучитьВыплатныеРеестрыЗаПоПериодуНаСервере(Объект.ВыплатныеРеестрыНачалоПериода,Объект.ВыплатныеРеестрыКонецПериода);
	Объект.тчВыплатныеРеестры.Очистить();
	Объект.тчВыплатныеРеестры.Загрузить(ТЗ);
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьУчастников(Команда)
	ЗаполнитьУчастниковНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьУчастниковНаСервере()
	
	ЭтаФорма.Модифицированность = Истина;

	мРегистраторов = Объект.тчВыплатныеРеестры.Выгрузить().ВыгрузитьКолонку("уп_ВыплатныеРеестры");
	ТЗ = Документы.хм_ВыгрузкаОписиИПорученииПенсияНаПочту.ПолучитьУчастниковНаСервере(мРегистраторов, Объект.ВидДеятельности, Объект.Территория, ВыводитьУчастниковБезУчастков);
	
	тчУчастники = Объект.спУчастники;

	тчУчастники.Очистить();
	тчУчастники.Загрузить(ТЗ);
	
КонецПроцедуры

&НаКлиенте
Процедура ВидДеятельностиПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.ВидДеятельности) И НЕ Объект.ВидДеятельности = ПредопределенноеЗначение("Перечисление.уп_ВидыДеятельности.ОПС") Тогда
	   	СтрокиНаУдаление = Объект.спУчастники.НайтиСтроки(Новый Структура("ВидДеятельности",ПредопределенноеЗначение("Перечисление.уп_ВидыДеятельности.ОПС")));
		Для каждого СтрокаНаУдаление Из СтрокиНаУдаление Цикл
			Объект.спУчастники.Удалить(СтрокаНаУдаление);	
		КонецЦикла;
	КонецЕсли;
		
	Если ЗначениеЗаполнено(Объект.ВидДеятельности) И НЕ Объект.ВидДеятельности = ПредопределенноеЗначение("Перечисление.уп_ВидыДеятельности.ПР") Тогда
	   	СтрокиНаУдаление = Объект.спУчастники.НайтиСтроки(Новый Структура("ВидДеятельности",ПредопределенноеЗначение("Перечисление.уп_ВидыДеятельности.ПР")));
		Для каждого СтрокаНаУдаление Из СтрокиНаУдаление Цикл
			Объект.спУчастники.Удалить(СтрокаНаУдаление);	
		КонецЦикла;
	КонецЕсли;
 	УправлениеФормой(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура спУчастникиТерриторияПриИзменении(Элемент)
 	УправлениеФормой(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если ИмяСобытия = "ХМ_ВыгрузкаОписиИПорученииПенсияНаПочту_Изменение" И Объект.Ссылка = Параметр Тогда
		ЭтаФорма.Прочитать();
	КонецЕсли;
КонецПроцедуры

#КонецОбласти